*      CAPTURA DE POLIZAS
*
SET DATE ANSI
SELECT 1
USE &XPATCB\CUENTA INDEX &XPATCB\CUENTA ALIAS CUENTA
SELECT 2
USE &XPATCB\SALDOS INDEX &XPATCB\SALDOS
SELECT 3
USE &XPATCB\POLIZA INDEX &XPATCB\POLIZA,&XPATCB\POLCTA
SET RELATION TO CUENTA INTO CUENTA
SELECT 4
USE CIAS
LOCATE FOR UNIDAD = XPATCB
XPOLIZA = POLIZA 
XFECHAI = FECHAI
XFECHAF = FECHAF
STORE FFFFFF TO XFECHA
XTIPO = 'D'
DIMENSION XREC(13)
XREGISTRO = REGISTRO 
SELECT 5
USE \COMUNES\RFC INDEX \COMUNES\RFC
SELECT 6
USE IPMAESTRO INDEX IPMAESTRO,IPMAESNOM
@ 4,01 TO 21,78 CLEAR
@ 23,01 SAY SPACE(77)
@ 4,1  SAY 'REGISTRO POLIZAS DEL:' GET XFECHA PICT '@E'
READ
IF XFECHA < XFECHAI  .OR. XFECHA > XFECHAF
   WAIT 'FECHA DE REGISTRO FUERA DE PERIODO' WIND
   CLOSE DATABASES
   SET DATE DMY
   RETURN
ENDIF
@5,35 SAY  '     Seleccionar '+CHR(24)+' '+CHR(25)
@4,35 SAY  'Tipo de Poliza:'
@4,51 PROMPT 'DIARIO  '
@4,51 PROMPT 'INGRESOS'
@4,51 PROMPT 'EGRESOS '
@4,51 PROMPT 'OTROS   '
@4,51 PROMPT 'INICIAL '
@4,51 PROMPT 'FINAL   '
MENU TO XTIPO
@ 4,60 SAY '# de Poliza:' GET XPOLIZA PICT '999999'
READ
IF XPOLIZA = 0 .OR. LASTKEY() = 27
   CLOSE DATABASES
   SET DATE DMY
   RETURN
ENDIF
XMESPOL = MONTH(XFECHA)
XANO    = YEAR(XFECHA)
DO CASE
   CASE  XTIPO = 5
   XMESPOL = 0
   XTIPO = 'S'
   CASE  XTIPO = 6
   XMESPOL = 13
   XTIPO = 'F'
   CASE XTIPO = 1
   XTIPO = 'D'
   CASE XTIPO = 2
   XTIPO = 'I'
   CASE XTIPO = 3
   XTIPO = 'E'
   CASE XTIPO = 4
   XTIPO = 'O'
ENDCASE
SELECT 3
SEEK DTOC(XFECHA)+XTIPO+STR(XPOLIZA,6,0)
SINO = 'NO'
STORE 0 TO XCARGOS,XABONOS
XOP = 0
IF EOF()
   DO ALTAS
ELSE
   XOP = 4
   @9,10  SAY 'YA EXISTE UNA POLIZA CON ESTOS DATOS'
   @10,10 SAY 'SELECCIONE LA OPCION A SEGUIR :'
   @12,10 SAY '1-  Modificar la Poliza '
   @14,10 SAY '2-  Agregar Registros   '
   @16,10 SAY '3 - Borrar la Poliza    '
   @18,10 SAY '4 - TERMINAR            ' GET XOP PICT '99' RANGE 1,4
   READ
   IF XOP = 2 .OR. XOP = 1
      XLLAVE= DTOC(XFECHA)+XTIPO+STR(XPOLIZA,6,0)
      DO WHILE  XLLAVE= DTOC(FECHA)+TIPO+STR(POLIZA,6,0) .AND. .NOT. EOF()
         IF MOVIMIENTO = '+'
            XCARGOS = XCARGOS + VALOR
         ELSE
            XABONOS = XABONOS + VALOR
         ENDIF
         SKIP
      ENDDO
   ENDIF
ENDIF
IF XOP = 1
   DO CAMBIOS
ENDIF
IF XOP = 2
   DO ALTAS
ENDIF
IF XOP = 3
   DO BORRA
ENDIF
SELECT 4
IF XPOLIZA > POLIZA
   REPLACE POLIZA WITH XPOLIZA,REGISTRO WITH XREGISTRO
ENDIF
CLOSE DATABASES
SET DATE DMY
RETURN
*
*
*
PROCEDURE ALTAS
*
@5,1 SAY REPLICATE(CHR(220),78)
@6,1 SAY 'CUENTA               DESCRIPCION                  REFERENCIA      VALOR  +/-'
@7,1 SAY REPLICATE(CHR(196),78)
N = 10
@9,1 TO 21,78 CLEAR
XCUENTA = 0
XSCUENTA = 0
XSSCUENTA = 0
XSSSCUENTA = 0
XVALOR = 0
XMOVI = '+'
XCONCEPTO = SPACE(40)
DO WHILE .T.
   @23,1 SAY SPACE(78)
   @8,1  SAY SPACE(78)
   XREFERENCIA = SPACE(10)
   XARTICULO = SPACE(15)
   SELECT 1
   SET FILTER TO TIPO <> 'M'
   @8,1  GET XCUENTA PICT '9999'
   @8,5  GET XSCUENTA PICT '9999'
   @8,9  GET XSSCUENTA PICT '999'
   @8,12 GET XSSSCUENTA PICT '999'
   @23,15 SAY '<F1> Lista                 <ESC> Terminar'
   READ
   IF LASTKEY() = 27
      EXIT
   ENDIF
   DO WHILE LASTKEY() = 4 .OR. LASTKEY() = 28 .OR. LASTKEY() = 29
      @ 23,5 SAY  '<F2> Agregar   '+CHR(24)+' '+CHR(25)+' Seleccionar   '+;
      CHR(17)+CHR(196)+CHR(217)+' Confirmar   <ESC> Terminar'
      ACTI POPUP POPCUENTA
      IF LASTKEY() = -1
         SINO = 'S'
         DO ALTACTA
         IF SINO = 'N'
            LOOP
         ENDIF
      ENDIF
      XCUENTA = CUENTA
      XSCUENTA = SCUENTA
      XSSCUENTA = SSCUENTA
      XSSSCUENTA = SSSCUENTA
      @8,1  GET XCUENTA PICT '9999'
      @8,5  GET XSCUENTA PICT '9999'
      @8,9  GET XSSCUENTA PICT '999'
      @8,12 GET XSSSCUENTA PICT '999'
      CLEAR GETS
   ENDDO
   IF LASTKEY() = 27
      LOOP
   ENDIF
   @23,1 SAY SPACE(78)
   SEEK STR(XCUENTA,4)+STR(XSCUENTA,4)+STR(XSSCUENTA,3)+STR(XSSSCUENTA,3)
   IF EOF()
      WAIT 'CUENTA NO EXISTE TECLEE RETURN PARA CONTINUAR' WIND
      LOOP
   ENDIF
   XNOMBRE = NOMBRE
   @N,1 SAY XNOMBRE
   SAVE SCREEN TO &XTERMINAL
   @9,9 TO 17,64 CLEAR
   @9,9 TO 17,64 DOUBLE
   @10,10 SAY 'CONCEPTO :   ' GET XCONCEPTO
   IF (XCUENTA = 1130 .OR. XCUENTA = 1135)
      @12,10 SAY 'ARTICULO     : ' GET XARTICULO
   ENDIF   
   IF XCUENTA = 1150 .AND. SCUENTA <= 3
      @12,10 SAY 'R.F.C.       : ' GET XARTICULO
   ENDIF   
   @14,10 SAY 'REFERENCIA : ' GET XREFERENCIA
   @16,10 SAY 'IMPORTE :    ' GET XVALOR PICT '99,999,999.99'
   @16,37 GET XMOVI PICT 'X'
   READ
   IF LASTKEY()= 27
      RESTORE SCREEN FROM &XTERMINAL
      LOOP
   ENDIF   
   IF XCUENTA = 1150 .AND. SCUENTA <= 3
      SELECT 5
      SEEK XARTICULO
      IF EOF()
         WAIT 'RFC NO EXISTE TECLEE RETURN PARA CONTINUAR' WIND
         RESTORE SCREEN FROM &XTERMINAL
         LOOP
      ENDIF
      SELECT 1
   ENDIF   
   
   IF (XCUENTA = 1130 .OR. XCUENTA = 1135) .AND. XREFERENCIA <> 'CPRAS'
      SELECT 6
      SEEK SUBSTR(XARTICULO,1,14)
      IF EOF()
         WAIT 'ARTICULO NO EXISTE TECLEE RETURN PARA CONTINUAR' WIND
         RESTORE SCREEN FROM &XTERMINAL
         LOOP
      ENDIF
      SELECT 1
   ENDIF   
   RESTORE SCREEN FROM &XTERMINAL
   IF LASTKEY() = 27 .OR. XVALOR = 0
      EXIT
   ENDIF
   IF XMOVI = '+'
      REPLACE CARGOS WITH CARGOS + XVALOR
   ELSE
      REPLACE ABONOS WITH ABONOS + XVALOR
   ENDIF
   SELECT 2
   SEEK STR(XCUENTA,4)+STR(XSCUENTA,4)+STR(XSSCUENTA,3)+STR(XSSSCUENTA,3)+STR(XMESPOL,2)+STR(XANO,4)
   IF EOF()
      APPEND BLANK
      REPLACE PERIODO WITH XMESPOL,ANO WITH XANO
      REPLACE CUENTA WITH XCUENTA,SCUENTA WITH XSCUENTA,SSCUENTA WITH XSSCUENTA,SSSCUENTA WITH XSSSCUENTA
   ENDIF
   IF XMOVI = '+'
      REPLACE CARGOS WITH CARGOS + XVALOR
      XCARGOS = XCARGOS + XVALOR
   ELSE
      REPLACE ABONOS WITH ABONOS + XVALOR
      XABONOS = XABONOS + XVALOR
   ENDIF
   SELECT 4
   IF POLIZA = XPOLIZA
      REPLACE POLIZA WITH XPOLIZA + 1,REGISTRO WITH XREGISTRO
   ENDIF 
   SELECT 3
   APPEND BLANK
   REPLACE FECHA WITH XFECHA,POLIZA WITH XPOLIZA,ARTICULO WITH XARTICULO
   REPLACE CUENTA WITH XCUENTA,SCUENTA WITH XSCUENTA,SSCUENTA WITH XSSCUENTA,SSSCUENTA WITH XSSSCUENTA
   REPLACE CONCEPTO WITH XCONCEPTO,VALOR WITH XVALOR,MOVIMIENTO WITH XMOVI,REGISTRO WITH XREGISTRO 
   REPLACE TIPO WITH XTIPO,REFERENCIA WITH XREFERENCIA,PERIODO WITH XMESPOL
   XREGISTRO = XREGISTRO + 1
   @N,19 SAY ' '
   @N,25 SAY XCONCEPTO PICT 'XXXXXXXXXXXXXXXXXXXXXXXXXX'
   @N,52 SAY XREFERENCIA PICT 'XXX'
   @N,56 SAY XARTICULO PICT 'XXXXXXX'
   @N,63 SAY XVALOR PICT '999,999,999.99'
   @N,77 SAY XMOVI PICT 'X' 
   XDIF = XCARGOS - XABONOS
   @21,3  SAY 'CARGOS :' GET XCARGOS PICT '9999,999,999.99'
   @21,29 SAY 'ABONOS :' GET XABONOS PICT '9999,999,999.99'
   @21,56 SAY 'DIF :'    GET XDIF    PICT '9999,999,999.99'
   CLEAR GETS
   N = N + 1
   IF N > 20
      @9,1 TO 20,78 CLEAR
      N = 10
   ENDIF
ENDDO


PROCEDURE ALTACTA
   APPEND BLANK
   ACTI WIND ALTAC
   @ 0,2 SAY 'Cuenta : ' GET CUENTA
   @ 1,2 SAY 'Nombre : ' GET NOMBRE
   READ
   IF CUENTA = '          '
      SINO = 'N'
      DELETE
   ENDIF
   DEAC WIND ALTAC

PROCEDURE BORRA
      @ 4,01 TO 21,78 CLEAR
      @ 23,01 SAY SPACE(77)
      @ 6,20 SAY 'Numero de Poliza :   ' GET XPOLIZA PICT '999999'
      @ 8,20 SAY 'Fecha de la Poliza : ' GET XFECHA PICT '@E'
      @10,20 SAY 'Tipo de Poliza :     ' GET XTIPO
      CLEAR GETS
      @23,10 SAY 'ESTA SEGURO DE QUERER BORRAR ESTA POLIZA SI/NO ? ' GET SINO PICT '@M NO,SI'
      READ
      IF SINO <> 'SI' .OR. LASTKEY() = 27
         RETURN
      ENDIF
      XLLAVE= DTOC(XFECHA)+XTIPO+STR(XPOLIZA,6,0)
      XMESPOL = MONTH(FECHA)
      XANO = YEAR(FECHA)
      IF TIPO = 'S'
         XMESPOL = 0
      ENDIF
      IF TIPO = 'F'
         XMESPOL = 13
      ENDIF
      STORE 0 TO XTCARGOS,XTABONOS
      DO WHILE  XLLAVE= DTOC(FECHA)+TIPO+STR(POLIZA,6,0) .AND. .NOT. EOF()
         XCUENTA  = CUENTA
         XSCUENTA  = SCUENTA
         XSSCUENTA  = SSCUENTA
         XSSSCUENTA  = SSSCUENTA
         XVALOR       = VALOR
         XCONCEPTO     = CONCEPTO
         XREFERENCIA    = REFERENCIA
         XMOVI           = MOVIMIENTO
         SELECT 2
         SEEK STR(XCUENTA,4)+STR(XSCUENTA,4)+STR(XSSCUENTA,3)+STR(XSSSCUENTA,3)+STR(XMESPOL,2)+STR(XANO,4)
         IF XMOVI = '+'
            REPLACE CARGOS WITH CARGOS - XVALOR
            XTCARGOS = XTCARGOS + XVALOR
         ELSE
            REPLACE ABONOS WITH ABONOS - XVALOR
            XTABONOS = XTABONOS + XVALOR
         ENDIF
         SELECT 3
         DELETE
         SKIP
      ENDDO
      @23,1 SAY SPACE(78)
      @14,20 SAY 'Total Cargos : ' GET XTCARGOS PICT '9999,999,999.99'
      @16,20 SAY 'Total Abonos : ' GET XTABONOS PICT '9999,999,999.99'
      CLEAR GETS
      WAIT 'Poliza Borrada   TECLEE RETURN PARA CONTINUAR' WIND


PROCEDURE CAMBIOS
   @5,1 TO 21,78 CLEAR
   @5,1  SAY REPLICATE(CHR(220),78)
   @6,1  SAY 'REGISTRO CUENTA'
   @6,20 SAY 'C O N C E P T O'
   @6,62 SAY 'I M P O R T E'
   @6,76 SAY '+/-'
   @7,1 SAY REPLICATE(CHR(196),78)
   N = 8
   GO TOP
   SEEK XLLAVE
   XRECI = RECNO() - 1
   XDIF = XCARGOS - XABONOS
   @21,3  SAY 'CARGOS :' GET XCARGOS PICT '9999,999,999.99'
   @21,29 SAY 'ABONOS :' GET XABONOS PICT '9999,999,999.99'
   @21,56 SAY 'DIF :'    GET XDIF    PICT '9999,999,999.99'
   CLEAR GETS
   M = 0
   DO WHILE  XLLAVE= DTOC(FECHA)+TIPO+STR(POLIZA,6,0) .AND. .NOT. EOF()
      M = M + 1
      XREC(M) = RECNO()
      @N,01 SAY M PICT '9999'
      @N,06 SAY CUENTA PICT '9999'
      @N,10 SAY SCUENTA PICT '9999'
      @N,14 SAY SSCUENTA PICT '999'
      @N,17 SAY SSSCUENTA PICT '999'
      @N,21 SAY CONCEPTO PICT 'XXXXXXXXXXXXXXXXXXXXXXXXX'
      @N,46 SAY ARTICULO PICT 'XXXXXXXXX'
      @N,56 SAY REFERENCIA PICT 'XXXXXX'
      @N,63 SAY VALOR PICT '999,999,999.99'
      @N,77 SAY MOVIMIENTO PICT 'X'
      N = N + 1
      SKIP
      IF EOF()
         XRECNOA = RECNO()-1
      ELSE
         XRECNOA = RECNO()
      ENDIF
      IF N > 20 .OR. XLLAVE<> DTOC(FECHA)+TIPO+STR(POLIZA,6,0)
         DO WHILE .T.
            XRENG = 0
            @ 23,6 SAY  'Numero de registro a modificar O Return para continuar' GET XRENG PICT '99' RANGE 1,13
            READ
            IF XRENG = 0
               EXIT
            ENDIF
            XREGISTRO = XREC(XRENG)
            SELECT 3
            IF XREGISTRO > RECCOUNT()
               EXIT
            ENDIF
            GO XREGISTRO
            IF EOF() .OR. DELETE()
               LOOP
            ENDIF
            XCUENTA  = CUENTA
            XSCUENTA  = SCUENTA
            XSSCUENTA  = SSCUENTA
            XSSSCUENTA  = SSSCUENTA
            XVALOR       = VALOR
            XCONCEPTO     = CONCEPTO
            XREFERENCIA    = REFERENCIA
            XMOVI           = MOVIMIENTO
            XARTICULO        = ARTICULO
            SELECT 1
            SEEK STR(XCUENTA,4)+STR(XSCUENTA,4)+STR(XSSCUENTA,3)+STR(XSSSCUENTA,3)
            IF XMOVI = '+'
               REPLACE CARGOS WITH CARGOS - XVALOR
            ELSE
               REPLACE ABONOS WITH ABONOS - XVALOR
            ENDIF
            SELECT 2
            SEEK STR(XCUENTA,4)+STR(XSCUENTA,4)+STR(XSSCUENTA,3)+STR(XSSSCUENTA,3)+STR(XMESPOL,2)+STR(XANO,4)
            IF XMOVI = '+'
               REPLACE CARGOS WITH CARGOS - XVALOR
               XCARGOS = XCARGOS - XVALOR
            ELSE
               REPLACE ABONOS WITH ABONOS - XVALOR
               XABONOS = XABONOS - XVALOR
            ENDIF
            XBORRA = 'NO'
            @24,10 SAY '     '
            @23,1 SAY SPACE(78)
            @23,20 SAY 'DESEA BORRAR EL REGISTRO SI/NO ? ' GET XBORRA PICT '@M NO,SI'
            READ
            IF XBORRA = 'SI'
               SELECT 3
               DELETE
               XDIF = XCARGOS + XABONOS
               @21,3  SAY 'CARGOS :' GET XCARGOS PICT '9999,999,999.99'
               @21,29 SAY 'ABONOS :' GET XABONOS PICT '9999,999,999.99'
               @21,56 SAY 'DIF :'    GET XDIF    PICT '9999,999,999.99'
               CLEAR GETS
               @XRENG+7,01 SAY SPACE(78)
               LOOP
            ENDIF
            SAVE SCREEN TO &XTERMINAL
            @07,9 TO 20,64 CLEAR
            @07,9 TO 20,64 DOUBLE
            @08,20 SAY 'CUENTA :       ' GET XCUENTA PICT '9999'
            @09,20 SAY 'S-CUENTA :     ' GET XSCUENTA PICT '9999'
            @10,20 SAY 'SS-CUENTA :    ' GET XSSCUENTA PICT '999'
            @11,20 SAY 'SSS-CUENTA :   ' GET XSSSCUENTA PICT '999'
            @13,10 SAY 'CONCEPTO :   ' GET XCONCEPTO
            @15,10 SAY 'ARTICULO/RFC : ' GET XARTICULO
            @17,10 SAY 'REFERENCIA : ' GET XREFERENCIA
            @19,10 SAY 'IMPORTE :    ' GET XVALOR PICT '99,999,999.99'
            @19,37 GET XMOVI PICT 'X'
            READ
            RESTORE SCREEN FROM &XTERMINAL
            IF XVALOR = 0
               LOOP
            ENDIF
            @23,1 SAY SPACE(78)
            
            
           IF XCUENTA = 1150 .AND. SCUENTA <= 3
           SELECT 5
           SEEK XARTICULO
           IF EOF()
              WAIT 'RFC NO EXISTE TECLEE RETURN PARA CONTINUAR' WIND
              RESTORE SCREEN FROM &XTERMINAL
              LOOP
           ENDIF
           SELECT 1
        ENDIF   
   
       IF (XCUENTA = 1130 .OR. XCUENTA = 1135) .AND. XREFERENCIA <> 'CPRAS'
          SELECT 6
          SEEK SUBSTR(XARTICULO,1,14)
          IF EOF()
             WAIT 'ARTICULO NO EXISTE TECLEE RETURN PARA CONTINUAR' WIND
             RESTORE SCREEN FROM &XTERMINAL
             LOOP
          ENDIF
          SELECT 1
       ENDIF   
       RESTORE SCREEN FROM &XTERMINAL

           
            SELECT 1
            SEEK STR(XCUENTA,4)+STR(XSCUENTA,4)+STR(XSSCUENTA,3)+STR(XSSSCUENTA,3)
            IF XMOVI = '+'
               REPLACE CARGOS WITH CARGOS + XVALOR
            ELSE
               REPLACE ABONOS WITH ABONOS + XVALOR
            ENDIF
            SELECT 2
            SEEK STR(XCUENTA,4)+STR(XSCUENTA,4)+STR(XSSCUENTA,3)+STR(XSSSCUENTA,3)+STR(XMESPOL,2)+STR(XANO,4)
            IF EOF()
               APPEND BLANK
               REPLACE PERIODO WITH XMESPOL,ANO WITH XANO
               REPLACE CUENTA WITH XCUENTA,SCUENTA WITH XSCUENTA,SSCUENTA WITH XSSCUENTA,SSSCUENTA WITH XSSSCUENTA
            ENDIF
            IF XMOVI = '+'
               REPLACE CARGOS WITH CARGOS + XVALOR
               XCARGOS = XCARGOS + XVALOR
            ELSE
               REPLACE ABONOS WITH ABONOS + XVALOR
               XABONOS = XABONOS + XVALOR
            ENDIF
            XDIF = XCARGOS - XABONOS
            @21,3  SAY 'CARGOS :' GET XCARGOS PICT '9999,999,999.99'
            @21,29 SAY 'ABONOS :' GET XABONOS PICT '9999,999,999.99'
            @21,56 SAY 'DIF :'    GET XDIF    PICT '9999,999,999.99'
            CLEAR GETS
            SELECT 3
            REPLACE CUENTA WITH XCUENTA,SCUENTA WITH XSCUENTA,SSCUENTA WITH XSSCUENTA,SSSCUENTA WITH XSSSCUENTA
            REPLACE REFERENCIA WITH XREFERENCIA,CONCEPTO WITH XCONCEPTO,VALOR WITH XVALOR
            REPLACE ARTICULO WITH XARTICULO,MOVIMIENTO WITH XMOVI
            @XRENG+7,01 SAY XRENG PICT '9999'
            @XRENG+7,06 SAY CUENTA PICT '9999'
            @XRENG+7,10 SAY SCUENTA PICT '9999'
            @XRENG+7,14 SAY SSCUENTA PICT '999'
            @XRENG+7,17 SAY SSSCUENTA PICT '999'
            @XRENG+7,21 SAY CONCEPTO PICT 'XXXXXXXXXXXXXXXXXXXXXXXXX'
            @XRENG+7,46 SAY ARTICULO PICT 'XXXXXXXX'
            @XRENG+7,56 SAY REFERENCIA PICT 'XXXXXX'
            @XRENG+7,63 SAY VALOR PICT '999,999,999.99'
            @XRENG+7,77 SAY MOVIMIENTO PICT 'X'
         ENDDO
*         EXIT
         @8,1 TO 20,78 CLEAR
         @23,1 SAY SPACE(78)
         N = 8
         M = 0
         IF EOF()
            EXIT
         ENDIF   
         GO XRECNOA
*         IF .NOT. EOF()
*            GO BOTTOM
*            IF XRECNOA < RECNO()
*               GO XRECNOA
*            ENDIF   
*         ENDIF
      ENDIF
   ENDDO
