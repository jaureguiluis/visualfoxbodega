*   GENERA LA POLIZA DIARIA DE VENTAS
*
STORE FFFFFF TO XFECHA,XFECHAF
@4,1 TO 21,78 CLEAR
@23,1 SAY SPACE(78)
XTITULO = 'POLIZA DE VENTAS'
@6,20  SAY XTITULO
@10,20 SAY 'Fecha de Poliza Inicial : ' GET XFECHA
@12,20 SAY 'Fecha de Poliza Final :   ' GET XFECHAF
@23,20 SAY '      <ESC> Terminar'
READ
IF LASTKEY() = 27 
   RETURN
ENDIF
SET COLOR TO 7*
@20,20 SAY 'FAVOR DE ESPERAR UN MOMENTO ....'
SET COLOR TO &XCOLOR
@ 23,1  SAY SPACE(78)
SET DATE ANSI
XMESPOL = MONTH(XFECHA)
SELECT 1
USE CCCLIENTE INDEX CCCLIENTE
SELECT 3
USE &XPATCB\POLIZA INDEX &XPATCB\POLIZA,&XPATCB\POLCTA
SEEK DTOC(XFECHA)+"D"+STR(1,6,0)
IF .NOT. EOF()
   WAIT 'CUIDADO YA EXISTE UNA POLIZA CON ESTOS DATOS ' WIND
   CLOSE DATABASES
   RETURN
ENDIF   
COPY STRUC TO &XTERMINAL
SELECT 6
USE &XTERMINAL
SELECT 5
USE IPGRUPOS INDEX IPGRUPOS
XARC=SUBSTR(XTERMINAL,1,7)
SELECT 9
USE IPJUNTAR  
COPY STRUC TO &XARC
SELECT 9
USE &XARC
INDEX ON GRUPO+ARTICULO+STR(CLAVE,2) TO &XTERMINAL
APPEND FROM IPENTRADAS FOR FECHAC >= XFECHA .AND. FECHAC <= XFECHAF
APPEND FROM IPSALIDAS  FOR FECHAC >= XFECHA .AND. FECHAC <= XFECHAF
GO TOP
IF EOF()
   SET DATE DMY
   CLOSE DATABASES
   RETURN
ENDIF   
STORE 0 TO XT1VALOR,XT3VALOR,XT7VALOR,XT79VALOR,XT51VALOR,XT52VALOR,XT53VALOR,XT54VALOR,XT80VALOR
SELECT 5
DO WHILE .NOT. EOF()
   XGRUPO   = NUMERO
   XNOMBRE  = NOMBRE
   XSCUENTA = VAL(GRUPOA)
   SELECT 9
   SEEK XGRUPO
   DO WHILE GRUPO = XGRUPO .AND. .NOT. EOF()
      XARTICULO = ARTICULO
      XPROPIO   = SUBSTR(ARTICULO,1,1)
      IF XPROPIO = 'P'
         XCUENTA = 1130
      ELSE
         XCUENTA = 1135
         WAIT 
      ENDIF   
      STORE 0 TO X1VALOR,X3VALOR,X7VALOR,X79VALOR,X51VALOR,X52VALOR,X53VALOR,X54VALOR,X80VALOR
      DO WHILE GRUPO = XGRUPO .AND. SUBSTR(ARTICULO,1,1) = XPROPIO .AND. .NOT. EOF()
         IF CLAVE = 51 
            X51VALOR    = X51VALOR    + VALOR
         ENDIF
         IF CLAVE = 52 
            X52VALOR    = X52VALOR    + VALOR
         ENDIF
         IF CLAVE = 54 
            X54VALOR    = X54VALOR    + VALOR
         ENDIF
         IF CLAVE = 1 
            X1VALOR    = X1VALOR    + VALOR
         ENDIF
         IF CLAVE = 79 
            X79VALOR    = X79VALOR    + VALOR
         ENDIF
         IF CLAVE = 3 
            X3VALOR    = X3VALOR    + VALOR
         ENDIF
         IF CLAVE = 7 
            X7VALOR    = X7VALOR    + VALOR
         ENDIF
         

         IF CLAVE = 53 
*           BONIFICACION INDIVIDUAL
            X53VALOR    = X53VALOR    + VALOR
            XVALOR = VALOR
            XCLIENTE = CLIENTE
            XFOLIO = FOLIO
            SELECT 1
            SEEK XCLIENTE
            XCLIENTE = SUBSTR(NOMBRE,1,21)
            SELECT 6
            APPEND BLANK
            REPLACE FECHA WITH XFECHA,POLIZA WITH 1
            REPLACE CUENTA WITH 4110,SCUENTA WITH 1,SSCUENTA WITH 0,SSSCUENTA WITH 0
            REPLACE VALOR WITH XVALOR,MOVIMIENTO WITH '+'
            REPLACE TIPO WITH 'D',PERIODO WITH XMESPOL
            REPLACE CONCEPTO WITH XCLIENTE+' F/'+STR(XFOLIO,6)
            SELECT 9
         ENDIF


         IF CLAVE = 80
*           BONIFICACION PUBLICIDAD
            X80VALOR    = X80VALOR    + VALOR
            XVALOR = VALOR
            XCLIENTE = CLIENTE
            XFOLIO = FOLIO
            SELECT 1
            SEEK XCLIENTE
            XCLIENTE = SUBSTR(NOMBRE,1,21)
            SELECT 6
            APPEND BLANK
            REPLACE FECHA WITH XFECHA,POLIZA WITH 1
            REPLACE CUENTA WITH 5200,SCUENTA WITH 8,SSCUENTA WITH 1,SSSCUENTA WITH 3
            REPLACE VALOR WITH XVALOR,MOVIMIENTO WITH '+'
            REPLACE TIPO WITH 'D',PERIODO WITH XMESPOL
            REPLACE CONCEPTO WITH XCLIENTE+' F/'+STR(XFOLIO,6)
            SELECT 9
         ENDIF
         SKIP
      ENDDO
      XT1VALOR    = XT1VALOR    + X1VALOR
      XT3VALOR    = XT3VALOR    + X3VALOR
      XT7VALOR    = XT7VALOR    + X7VALOR
      XT51VALOR   = XT51VALOR   + X51VALOR
      XT52VALOR   = XT52VALOR   + X52VALOR
      XT53VALOR   = XT53VALOR   + X53VALOR
      XT54VALOR   = XT54VALOR   + X54VALOR
      XT79VALOR   = XT79VALOR   + X79VALOR
      XT80VALOR   = XT80VALOR   + X80VALOR



      IF X1VALOR <>0
         SELECT 6
         APPEND BLANK
         REPLACE FECHA WITH XFECHA,POLIZA WITH 1
         REPLACE CUENTA WITH XCUENTA,SCUENTA WITH XSCUENTA,SSCUENTA WITH 1,SSSCUENTA WITH 0
         REPLACE VALOR WITH X1VALOR,MOVIMIENTO WITH '+'
         REPLACE TIPO WITH 'D',REFERENCIA WITH 'CPRA',PERIODO WITH XMESPOL
      ENDIF

      IF X54VALOR <>0
      
*        DEVOLUCION X PROVEEDOR
  
         SELECT 6
         APPEND BLANK
         REPLACE FECHA WITH XFECHA,POLIZA WITH 1
         REPLACE CUENTA WITH XCUENTA,SCUENTA WITH XSCUENTA,SSCUENTA WITH 1,SSSCUENTA WITH 0
         REPLACE VALOR WITH X1VALOR,MOVIMIENTO WITH '+'
         REPLACE TIPO WITH 'D',REFERENCIA WITH 'CPRA',PERIODO WITH XMESPOL
      ENDIF


      SELECT 9
   ENDDO
   SELECT 5
   SKIP
ENDDO
SELECT 6
APPEND BLANK
REPLACE FECHA WITH XFECHA,POLIZA WITH 1
REPLACE CUENTA WITH 2300,SCUENTA WITH 1,SSCUENTA WITH 0,SSSCUENTA WITH 0
REPLACE VALOR WITH XT1VALOR,MOVIMIENTO WITH '-'
REPLACE TIPO WITH 'D',REFERENCIA WITH 'CPRA',PERIODO WITH XMESPOL
IF SUBSTR(PAT,2,2) = "89"
   REPLACE SCUENTA WITH 50
ENDIF   

*  CREDITO    

IF XT51VALOR <>0
   SELECT 6
   APPEND BLANK
   REPLACE FECHA WITH XFECHA,POLIZA WITH 1
   REPLACE CUENTA WITH 4101,SCUENTA WITH 1,SSCUENTA WITH 0,SSSCUENTA WITH 0
   REPLACE CONCEPTO WITH 'VENTA CREDITO',VALOR WITH XT51VALOR,MOVIMIENTO WITH '-'
   REPLACE TIPO WITH 'D',PERIODO WITH XMESPOL
   APPEND BLANK
   REPLACE FECHA WITH XFECHA,POLIZA WITH 1
   REPLACE CUENTA WITH 1110,SCUENTA WITH 1,SSCUENTA WITH 0,SSSCUENTA WITH 0
   REPLACE CONCEPTO WITH 'VENTA CREDITO',VALOR WITH XT51VALOR,MOVIMIENTO WITH '+'
   REPLACE TIPO WITH 'D',PERIODO WITH XMESPOL
ENDIF

* DEVOLUCION

IF XT3VALOR <>0
   SELECT 6
   APPEND BLANK
   REPLACE FECHA WITH XFECHA,POLIZA WITH 1
   REPLACE CUENTA WITH 4120,SCUENTA WITH 1,SSCUENTA WITH 0,SSSCUENTA WITH 0
   REPLACE CONCEPTO WITH 'DEVOLUCION',VALOR WITH XT3VALOR,MOVIMIENTO WITH '+'
   REPLACE TIPO WITH 'D',PERIODO WITH XMESPOL
ENDIF

* CANCELACION

IF XT7VALOR <>0
     SELECT 6
     APPEND BLANK
     REPLACE FECHA WITH XFECHA,POLIZA WITH 1
     REPLACE CUENTA WITH 4101,SCUENTA WITH 1,SSCUENTA WITH 0,SSSCUENTA WITH 0
     REPLACE CONCEPTO WITH 'CANCELACION',VALOR WITH XT7VALOR,MOVIMIENTO WITH '+'
     REPLACE TIPO WITH 'D',PERIODO WITH XMESPOL
ENDIF


  
* BONIFICACION + CANCELACION + DEVOLUCION

IF XT80VALOR+XT53VALOR+XT3VALOR+XT7VALOR <>0
   SELECT 6
   APPEND BLANK
   REPLACE FECHA WITH XFECHA,POLIZA WITH 1
   REPLACE CUENTA WITH 1110,SCUENTA WITH 1,SSCUENTA WITH 0,SSSCUENTA WITH 0
   REPLACE CONCEPTO WITH 'DEV-CAN-BONI',VALOR WITH XT53VALOR+XT3VALOR+XT7VALOR,MOVIMIENTO WITH '-'
   REPLACE TIPO WITH 'D',PERIODO WITH XMESPOL
   IF SUBSTR(PAT,2,2) = "89"
      REPLACE SCUENTA WITH 50
   ENDIF   
ENDIF
XARC=SUBSTR(XTERMINAL,1,6)
SELECT 6
SORT ON MOVIMIENTO,CUENTA,SCUENTA,SSCUENTA TO &XARC
CLOSE DATABASES
SELECT 3
USE &XPATCB\POLIZA INDEX &XPATCB\POLIZA,&XPATCB\POLCTA
APPEND FROM &XARC
SET DATE DMY
CLOSE DATABASES

@14,20 SAY 'SE GENERO LA SIGUIENTE POLIZA:'
@16,20 SAY 'Numero 1 DIARIO DEL : ' GET XFECHA
@20,20 SAY '                                '
CLEAR GETS
WAIT ''
RETURN
